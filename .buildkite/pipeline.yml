steps:
  - label: ":golang: unit test"
    agents:
      queue: "workers"
      docker: "*"
    command: "make unit_test"
    artifact_paths:
      - ".build/coverage/*.out"
    plugins:
      - docker-compose#v3.0.0:
          run: unit-test
          config: docker/buildkite/docker-compose.yml

  - label: ":golang: integration test sticky OFF"
    agents:
      queue: "workers"
      docker: "*"
    command: "make integ_test_sticky_off"
    artifact_paths:
      - ".build/coverage/*.out"
    plugins:
      - docker-compose#v3.0.0:
          run: integ-test
          config: docker/buildkite/docker-compose.yml
    plugins:
      - docker-login#v2.0.1:
          username: ubercadence
          password-env: DOCKER_LOGIN_PASSWORD

  - label: ":golang: integration test sticky ON"
    agents:
      queue: "workers"
      docker: "*"
    command: "make integ_test_sticky_on"
    artifact_paths:
      - ".build/coverage/*.out"
    plugins:
      - docker-compose#v3.0.0:
          run: integ-test
          config: docker/buildkite/docker-compose.yml

  - wait

  - label: ":golang: cover_ci"
    agents:
      queue: "workers"
      docker: "*"
    command: "./scripts/buildkite/gocov.sh"
    plugins:
      - docker-compose#v3.0.0:
          run: coverage-report
          config: docker/buildkite/docker-compose.yml
